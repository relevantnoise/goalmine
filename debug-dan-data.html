<!DOCTYPE html>
<html>
<head>
    <title>Debug Dan's Assessment Data</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .data { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { margin-top: 20px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Debug Dan's Assessment Data</h1>
    
    <div class="section">
        <h2>Fetch Dan's Data from Database</h2>
        <button onclick="fetchDanData()">Fetch Dan's Assessment Data</button>
        <div id="result" class="result"></div>
    </div>

    <script>
        async function fetchDanData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Fetching data...</p>';
            
            try {
                // Direct Supabase API call using anon key
                const response = await fetch('https://dhlcycjnzwfnadmsptof.supabase.co/rest/v1/rpc/get_user_assessment_data', {
                    method: 'POST',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_email: 'danlynn@gmail.com' })
                });

                if (!response.ok) {
                    // Try direct table queries instead
                    await fetchDirectData();
                    return;
                }

                const data = await response.json();
                displayData(data);
                
            } catch (error) {
                console.error('Error:', error);
                // Fallback to direct table queries
                await fetchDirectData();
            }
        }
        
        async function fetchDirectData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Fetching direct table data...</p>';
            
            try {
                // Query pillar_assessments table directly
                const pillarsResponse = await fetch('https://dhlcycjnzwfnadmsptof.supabase.co/rest/v1/pillar_assessments?user_email=eq.danlynn@gmail.com', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw'
                    }
                });

                // Query work_happiness table directly
                const workResponse = await fetch('https://dhlcycjnzwfnadmsptof.supabase.co/rest/v1/work_happiness?user_email=eq.danlynn@gmail.com', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobGN5Y2puendmbmFkbXNwdG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNjA2MTcsImV4cCI6MjA0MzYzNjYxN30.dvHfyb3bNw9DT83q-tz09dKnK3FjyD5XQg7Yj0AwTMw'
                    }
                });

                const pillarsData = await pillarsResponse.json();
                const workData = await workResponse.json();

                displayDirectData(pillarsData, workData);

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error fetching data: ${error.message}</p>`;
            }
        }
        
        function displayDirectData(pillarsData, workData) {
            const resultDiv = document.getElementById('result');
            
            // Process the data like the algorithm would
            const elements = pillarsData.map(pillar => ({
                name: pillar.pillar_name,
                current: pillar.current_hours_per_week || 0,
                desired: pillar.ideal_hours_per_week || 0,
                importance: pillar.importance_level || 0,
                gap: (pillar.ideal_hours_per_week || 0) - (pillar.current_hours_per_week || 0)
            }));

            // Find biggest gaps
            const biggestGapSize = elements.length > 0 
                ? Math.max(...elements.map(el => Math.abs(el.gap || 0)))
                : 0;
            const biggestGaps = elements.filter(el => Math.abs(el.gap || 0) === biggestGapSize && biggestGapSize > 0);

            // Work happiness analysis
            let workInsights = { focus: null, gaps: {}, maxGap: 0, allFocusAreas: [] };
            if (workData && workData.length > 0) {
                const work = workData[0];
                const gaps = {
                    impact: (work.impact_desired || 0) - (work.impact_current || 0),
                    enjoyment: (work.enjoyment_desired || 0) - (work.enjoyment_current || 0),
                    income: (work.income_desired || 0) - (work.income_current || 0),
                    flexibility: (work.remote_desired || 0) - (work.remote_current || 0)
                };
                workInsights.gaps = gaps;
                workInsights.maxGap = Math.max(...Object.values(gaps));
                workInsights.allFocusAreas = Object.keys(gaps).filter(key => gaps[key] === workInsights.maxGap);
                workInsights.focus = workInsights.allFocusAreas[0];
            }

            resultDiv.innerHTML = `
                <div class="success">
                    <h3>Dan's Assessment Data Analysis</h3>
                    
                    <div class="section">
                        <h4>Raw Pillar Assessments Data:</h4>
                        <div class="data"><pre>${JSON.stringify(pillarsData, null, 2)}</pre></div>
                    </div>
                    
                    <div class="section">
                        <h4>Raw Work Happiness Data:</h4>
                        <div class="data"><pre>${JSON.stringify(workData, null, 2)}</pre></div>
                    </div>
                    
                    <div class="section">
                        <h4>Processed Elements (What Algorithm Sees):</h4>
                        <div class="data"><pre>${JSON.stringify(elements, null, 2)}</pre></div>
                    </div>
                    
                    <div class="section">
                        <h4>Algorithm Analysis Results:</h4>
                        <div class="data">
                            <p><strong>Biggest Gap Size:</strong> ${biggestGapSize}h</p>
                            <p><strong>Biggest Gaps:</strong> ${biggestGaps.map(g => `${g.name} (${g.gap}h)`).join(', ')}</p>
                            <p><strong>Work Focus Area(s):</strong> ${workInsights.allFocusAreas.join(', ') || 'None'}</p>
                            <p><strong>Work Max Gap:</strong> ${workInsights.maxGap}</p>
                            <p><strong>Work Gaps Detail:</strong></p>
                            <pre>${JSON.stringify(workInsights.gaps, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayData(data) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="success">
                    <h3>Success!</h3>
                    <div class="data"><pre>${JSON.stringify(data, null, 2)}</pre></div>
                </div>
            `;
        }
    </script>
</body>
</html>