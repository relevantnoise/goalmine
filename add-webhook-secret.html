<!DOCTYPE html>
<html>
<head>
    <title>Add Webhook Secret to Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .step { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        input[type="text"] { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .url { word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üéØ Stripe Webhook Configuration</h1>
    
    <div class="step info">
        <h2>Step 1: Your Webhook URL</h2>
        <p><strong>Use this exact URL in Stripe Dashboard:</strong></p>
        <div class="url">https://dhlcycjnzwfnadmsptof.supabase.co/functions/v1/stripe-webhook</div>
    </div>

    <div class="step info">
        <h2>Step 2: Events to Select</h2>
        <ul>
            <li>‚úÖ customer.subscription.created</li>
            <li>‚úÖ customer.subscription.updated</li>
            <li>‚úÖ customer.subscription.deleted</li>
            <li>‚úÖ invoice.payment_succeeded</li>
            <li>‚úÖ invoice.payment_failed</li>
            <li>‚úÖ customer.created</li>
            <li>‚úÖ customer.updated</li>
        </ul>
    </div>

    <div class="step warning">
        <h2>Step 3: Add Webhook Secret</h2>
        <p>After creating the webhook in Stripe, copy the signing secret and paste it here:</p>
        <input type="text" id="webhookSecret" placeholder="whsec_..." />
        <button onclick="addSecret()">Add Secret to Supabase</button>
        <div id="result"></div>
    </div>

    <div class="step">
        <h2>Step 4: Quick Test</h2>
        <button onclick="testWebhook()">Test Webhook Endpoint</button>
        <div id="testResult"></div>
    </div>

    <script>
        async function addSecret() {
            const secret = document.getElementById('webhookSecret').value.trim();
            if (!secret.startsWith('whsec_')) {
                document.getElementById('result').innerHTML = '<p style="color: red;">‚ùå Invalid secret format. Must start with "whsec_"</p>';
                return;
            }

            document.getElementById('result').innerHTML = `
                <h3>üîß Manual Step Required:</h3>
                <p>Add this environment variable to your Supabase project:</p>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <strong>Variable Name:</strong> STRIPE_WEBHOOK_SECRET<br>
                    <strong>Value:</strong> ${secret}
                </div>
                <p><strong>Where to add it:</strong></p>
                <ol>
                    <li>Go to: <a href="https://supabase.com/dashboard/project/dhlcycjnzwfnadmsptof/settings/functions" target="_blank">Supabase Functions Settings</a></li>
                    <li>Scroll to "Environment variables"</li>
                    <li>Click "Add environment variable"</li>
                    <li>Name: <code>STRIPE_WEBHOOK_SECRET</code></li>
                    <li>Value: <code>${secret}</code></li>
                    <li>Click "Save"</li>
                </ol>
                <p style="color: green;">‚úÖ After adding the variable, your webhook will be ready!</p>
            `;
        }

        async function testWebhook() {
            document.getElementById('testResult').innerHTML = '<p>üß™ Testing webhook endpoint...</p>';
            
            try {
                const response = await fetch('https://dhlcycjnzwfnadmsptof.supabase.co/functions/v1/stripe-webhook', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'stripe-signature'
                    }
                });

                if (response.ok) {
                    document.getElementById('testResult').innerHTML = `
                        <p style="color: green;">‚úÖ Webhook endpoint is responding correctly!</p>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Ready for Stripe webhooks</strong></p>
                    `;
                } else {
                    document.getElementById('testResult').innerHTML = `
                        <p style="color: orange;">‚ö†Ô∏è Unexpected response: ${response.status}</p>
                        <p>This may still work for actual Stripe webhooks.</p>
                    `;
                }
            } catch (error) {
                document.getElementById('testResult').innerHTML = `
                    <p style="color: red;">‚ùå Test failed: ${error.message}</p>
                    <p>Check your internet connection and try again.</p>
                `;
            }
        }

        // Auto-test on page load
        window.onload = () => testWebhook();
    </script>
</body>
</html>